<!DOCTYPE html>
<html>
<head>
    <title>S3 Upload Test</title>
</head>
<body>
    <h1>S3 Upload Test</h1>
    <input type="file" id="fileInput" />
    <button onclick="testUpload()">Test S3 Upload</button>
    <div id="progress"></div>
    <div id="logs"></div>

    <script>
        async function testUpload() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Please select a file');
                return;
            }
            
            console.log('Starting upload test for file:', file.name);
            
            try {
                // Step 1: Get presigned URL
                const uploadUrlResponse = await fetch('/api/job-cards/1/files/upload-url', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        fileName: file.name,
                        contentType: file.type,
                        mediaType: 'raw',
                        fileSize: file.size
                    })
                });
                
                if (!uploadUrlResponse.ok) {
                    throw new Error(`Failed to get upload URL: ${uploadUrlResponse.status}`);
                }
                
                const { uploadUrl, s3Key } = await uploadUrlResponse.json();
                console.log('Got presigned URL:', s3Key);
                
                // Step 2: Upload to S3
                const xhr = new XMLHttpRequest();
                
                xhr.upload.onprogress = (event) => {
                    if (event.lengthComputable) {
                        const progress = Math.round((event.loaded / event.total) * 100);
                        document.getElementById('progress').textContent = `Upload progress: ${progress}%`;
                        console.log(`Upload progress: ${progress}%`);
                    }
                };
                
                xhr.onload = () => {
                    if (xhr.status === 200) {
                        console.log('S3 upload completed successfully');
                        document.getElementById('logs').innerHTML += '<p>S3 upload completed successfully</p>';
                        
                        // Step 3: Save metadata
                        saveMetadata(file, s3Key);
                    } else {
                        console.error('S3 upload failed with status:', xhr.status);
                        document.getElementById('logs').innerHTML += `<p>S3 upload failed: ${xhr.status}</p>`;
                    }
                };
                
                xhr.onerror = () => {
                    console.error('S3 upload error');
                    document.getElementById('logs').innerHTML += '<p>S3 upload error</p>';
                };
                
                xhr.open('PUT', uploadUrl);
                xhr.setRequestHeader('Content-Type', file.type);
                xhr.send(file);
                
            } catch (error) {
                console.error('Upload test failed:', error);
                document.getElementById('logs').innerHTML += `<p>Upload test failed: ${error.message}</p>`;
            }
        }
        
        async function saveMetadata(file, s3Key) {
            try {
                const response = await fetch('/api/job-cards/1/files/metadata', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        fileName: file.name,
                        originalName: file.name,
                        s3Key: s3Key,
                        fileSize: file.size,
                        mimeType: file.type,
                        mediaType: 'raw',
                        serviceCategory: 'general'
                    })
                });
                
                if (response.ok) {
                    console.log('Metadata saved successfully');
                    document.getElementById('logs').innerHTML += '<p>Metadata saved successfully</p>';
                } else {
                    console.error('Failed to save metadata');
                    document.getElementById('logs').innerHTML += '<p>Failed to save metadata</p>';
                }
            } catch (error) {
                console.error('Metadata save error:', error);
                document.getElementById('logs').innerHTML += `<p>Metadata save error: ${error.message}</p>`;
            }
        }
    </script>
</body>
</html>